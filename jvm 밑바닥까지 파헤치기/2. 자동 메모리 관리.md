# 2. 자동 메모리 관리



## 런타임 데이터 영역

- 스레드별 개별 데이터 영역
  - 프로그램 카운터
  - 자바 가상머신 스택 : 자바 바이트 코드에서 사용하는 스택, 주로 지역변수
  - 네이티브 메서드 스택 : 네이티브 메서드에서 사용하는 스택
- 스레드 공유 데이터 영역
  - 자바 힙
    - 가비지 컬렉터가 관리하는 영역으로 GC 힙으로 부르기도 함
  - 메서드 영역
    - 자바 힙과 분리하기 위해 Non-heap 으로 부르기도 함
    - 타입정보, 상수, 정적변수
    - 핫스팟 VM 은 영구힙에 메서드 영역을 구현했었다
  - 런타임 상수 풀
    - 클래스 버전, 필드, 메서드, 인터페이스 등의 리터럴 / 심벌 정보
- 다이렉트 메모리
  - 힘이 아닌 메모리를 직저 할당하는 방식
  - 가상 머신 런타임에 속하지 않는다



## 핫스팟 가상 머신에서의 객체 들여다보기

### 객체 생성

- 객체 인스턴스를 만들 때 ( new 키워드를 사용할 때) 아래 두가지 과정이 발생
  - jvm 관점에서의 객체 생성 (new)
    - 메모리 할당
  - java 관점에서의 객체 생성 (invokespecial)
    - 생성자 실행 (<init>())

- jvm 객체 메모리 할당 전략
  - 멀티스레드에서 객체 생성을 할 경우 힙 메모리 동시성이 발생한다.
  - 전략 1. CAS 로 메모리 할당
  - 전략 2. 스레드 마다 별도의 메모리 공간 할당 ( TLAB )

### 객체의 메모리 레이아웃

- 객체헤더
  - 해시코드
  - GC 세대 나이
  - 락 상태 플래그
  - 편향된 스레드 Id, 타임스탬프 ( 편향 락 )
- 인스턴스데이터
- 정렬패딩

### 객체에 접근하기

- 핸들 방식
  - 자바 힙에서 핸들 풀을 관리
  - 핸들 풀은 객체 인스턴스 포인터 ( 힙 영역 ), 객체 타입 포인터 ( 메서드 영역 )
  - 객체의 위치가 바뀌어도 참조는 그대로 유지할 수 있다.
    - 핸들 풀의 주소는 업데이트 해줘야 함
- 다이렉트 포인터 방식
  - 객체 인스턴스에서 객체 타입 포인터를 가지고 있는 방식
  - 속도가 빠르다